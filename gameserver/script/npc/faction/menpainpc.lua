--	Môn phái chưởng môn nhân, tiếp dẫn nhân

local tbMenPaiNpc = {}
Npc.tbMenPaiNpc = tbMenPaiNpc

tbMenPaiNpc.tbFcts = {
  {
    szDesc = "Bản tự tọa lạc trên núi Thiếu Thất ở Hà Nam, là Huyền môn chính tông, Phật pháp trăm năm. Trảm yêu trừ ma, bảo vệ lòng người là tâm nguyện của tăng chúng bản tự.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 9, 1731, 3064 },
    tbMiji = { 1, 2 },
  },
  {
    szDesc = "Hồ Động Đình sóng nước mênh mông, từ xưa đã là vùng đất trù phú. Thiên Vương Bang ta từ khi được Chung Dương nhị vị vương gia sáng lập đến nay, tín niệm trước sau chỉ có tám chữ: Trừng ác dương thiện, cứu dân độ thế.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 22, 1703, 2987 },
    tbMiji = { 3, 4 },
  },
  {
    szDesc = "Từ xưa Thục đạo nan, nan ư thướng thanh thiên. Đường Gia Bảo ta tuy ở riêng một góc Tây Nam, nhưng trong lòng chưa từng nguôi ý muốn nắm giữ ngôi vị đầu lĩnh võ lâm Trung Nguyên, cống hiến cho Đại Tống phồn hoa.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 18, 1652, 3187 },
    tbMiji = { 5, 6 },
  },
  {
    szDesc = "Ba mươi năm trước, một tờ lệnh truy sát của triều đình đã đẩy Ngũ Độc Giáo ta vào rừng sâu Nam Cương, gần như toàn quân bị diệt. Nay chúng ta đã nghỉ ngơi dưỡng sức, tái xuất giang hồ. Lòng người trong thiên hạ như lửa cháy ngoài đồng, đâu có đúng sai, chỉ có thắng làm vua thua làm giặc mà thôi. Với bài học đau thương lần trước, lần này chúng ta sẽ không tái phạm nữa.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 20, 1459, 2984 },
    tbMiji = { 7, 8 },
  },
  {
    szDesc = "Phái Nga Mi dưới sự dẫn dắt của chưởng môn đời trước là Thanh Hiểu Sư Thái và chưởng môn đời nay là Vô Tưởng Sư Thái, nay đã cùng Thiếu Lâm, Võ Đang nắm giữ vị thế đầu lĩnh võ lâm. Môn hạ của phái ta đều là nữ tử, mang trong mình ý niệm xuất thế, không muốn dính vào ân oán giang hồ, chỉ cầu trong sạch bản thân.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 16, 1712, 2908 },
    tbMiji = { 9, 10 },
  },
  {
    szDesc = "Năm xưa khi Thúy Yên Môn ta thời cực thịnh, trăm hoa đua nở, đứng đầu võ lâm. Nay các sư tỷ đời trước đều đã có nơi chốn riêng, đệ tử trẻ tuổi vẫn chưa trưởng thành, chính là lúc cầu hiền như khát.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 17, 1355, 2940 },
    tbMiji = { 11, 12 },
  },
  {
    szDesc = "Mấy chục năm trước trong trận Thái Thạch, Lão bang chủ Cái Bang ta là Hà Nhân Ngã đã dẫn dắt Tứ đại trưởng lão cùng hàng ngàn đệ tử tấn công quân Kim, trợ giúp Ngu Doãn Văn đại nhân giữ vững Trường Giang. Nhưng trận chiến đó cũng mang lại đả kích hủy diệt cho bang ta, từ đó nhân lực suy tàn, không còn cảnh thịnh vượng. Ta ở trong thôn này, chính là muốn mời gọi các chí sĩ yêu nước gia nhập Cái Bang, cùng nhau chống giặc Kim.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 15, 1706, 3120 },
    tbMiji = { 13, 14 },
  },
  {
    szDesc = "Triều đình và Nam Tống sau Hòa nghị Long Hưng, đã có mấy chục năm nghỉ ngơi dưỡng sức, thực ra Thiên Nhẫn chúng ta đâu có muốn chiến tranh? Chỉ cần có chiến tranh, sẽ có người chết. Khi có thể không chết, ai mà không muốn sống? Nhưng Thát Đát, Tây Hạ ở bên cạnh như hổ rình mồi, không thể không đề phòng.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 10, 1797, 3296 },
    tbMiji = { 15, 16 },
  },
  {
    szDesc = "Điện Long Hổ trên núi Võ Đang là tông thất của Đạo gia trong thiên hạ. Từ khi chưởng môn đời trước là Thiên Mục Đạo Trưởng mất tích, Trùng Dương Chân Nhân vẫn luôn đảm nhiệm vai trò khách tọa chưởng môn. Võ Đang ta tọa lạc tại vùng đất nhạy cảm giữa Tống và Kim, Chân Nhân những năm qua đã quá lao lực, thật mong có anh tài trẻ tuổi có thể giúp đỡ người.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 14, 1408, 2959 },
    tbMiji = { 17, 18 },
  },
  {
    szDesc = "Núi Tây Côn Lôn vạn năm tuyết phủ, nếu không vì nội loạn, Băng Tuyết Kiếm Khí của Côn Lôn Kiếm Tông đã sớm quét ngang Trung Nguyên. Nay đệ tử của Kiếm Hoàng Trử Khi Thiên năm xưa là Thu Thạch tiên sinh đã từ Tây Vực trở về, cùng với Hạ viện thủ tọa Tạ Vũ Điền tiên sinh liên thủ, Côn Lôn Phái cuối cùng cũng có một khí thế mới, thật đáng mừng.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 12, 1636, 3034 },
    tbMiji = { 19, 20 },
  },
  {
    szDesc = "Minh Giáo ta từ sau đời Đường, từ cực thịnh chuyển sang suy, bị triều đình ruồng bỏ, chỉ có thể bí mật truyền giáo trong dân gian. Lại vì thế mà bị người đời hiểu lầm là tà giáo, tình cảnh này biết tỏ cùng ai? Đại Giáo Tông đương nhiệm quyết định nhập thế cứu dân, dẫn dắt vạn ngàn bá tánh lao khổ cùng bước vào thế giới quang minh.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 224, 1747, 3026 },
    tbMiji = { 21, 22 },
  },
  {
    szDesc = "Đoàn Thị trăm năm dốc lòng trị vì, nhưng vẫn không thể trở thành một đại quốc. Ấy là vì trong nước hai tộc Ô Man và Bạch Man không thể đồng tâm hiệp lực, cùng nhau thực hiện quốc sách. Đế quân đương thời có tâm muốn làm nên nghiệp lớn, hoàn thành tâm nguyện trăm năm của tiên tổ Đoàn Thị! Vì thế quảng nạp anh hùng thiên hạ, gia nhập Đoàn Thị ta.\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 19, 1691, 3125 },
    tbMiji = { 23, 24 },
  },
  {
    szDesc = "Cổ Mộ ta quanh năm ẩn mình trong Hoạt Tử Nhân Mộ ở Chung Nam Sơn, giang hồ biến động khó mà được yên ổn. Nếu gia nhập Cổ Mộ ta, phải ít nghĩ, ít niệm, ít ham muốn, ít chuyện, ít nói, ít cười, ít sầu, ít vui, ít mừng, ít giận, ít thích, ít ghét. Hồng trần ngàn trượng, tuy chưa từ bỏ cũng như không liên quan, ngươi có còn muốn vào Cổ Mộ ta không? \n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>",
    tbTransPos = { 2261, 1684, 2960 },
    tbMiji = { 25, 26 },
  },
}

-- Thời gian hiệu lực của vũ khí khi trải nghiệm môn phái (giây)
tbMenPaiNpc.WEAPON_LIVE_TIME = 600

-- Tọa độ điểm thử nghiệm kỹ năng tại bản đồ cấp 5 tương ứng với các Tân Thủ Thôn
tbMenPaiNpc.TBLV5_TRYSKILL_POS = {
  [1] = { 30, 1722, 3876 },
  [2] = { 31, 1821, 3676 },
  [3] = { 32, 1750, 3655 },
  [4] = { 33, 1948, 3870 },
  [5] = { 34, 1831, 3775 },
  [6] = { 35, 1915, 3754 },
  [7] = { 36, 1692, 3695 },
  [8] = { 37, 1760, 3666 },
}

-- Thông tin về hai nhánh và vũ khí tương ứng của các môn phái
tbMenPaiNpc.tbFactionWeaponInfo = {
  [1] = { szName = "Đao Thiếu Lâm", tbGDPL = { 2, 1, 1425, 10 } },
  [2] = { szName = "Côn Thiếu Lâm", tbGDPL = { 2, 1, 1426, 10 } },
  [3] = { szName = "Thương Thiên Vương", tbGDPL = { 2, 1, 1427, 10 } },
  [4] = { szName = "Chùy Thiên Vương", tbGDPL = { 2, 1, 1428, 10 } },
  [5] = { szName = "Tụ Tiễn Đường Môn", tbGDPL = { 2, 2, 162, 10 } },
  [6] = { szName = "Cạm Bẫy Đường Môn", tbGDPL = { 2, 2, 161, 10 } },
  [7] = { szName = "Đao Ngũ Độc", tbGDPL = { 2, 1, 1429, 10 } },
  [8] = { szName = "Chưởng Ngũ Độc", tbGDPL = { 2, 1, 1430, 10 } },
  [9] = { szName = "Phụ Trợ Nga Mi", tbGDPL = { 2, 1, 1432, 10 } },
  [10] = { szName = "Chưởng Nga Mi", tbGDPL = { 2, 1, 1431, 10 } },
  [11] = { szName = "Kiếm Thúy Yên", tbGDPL = { 2, 1, 1433, 10 } },
  [12] = { szName = "Đao Thúy Yên", tbGDPL = { 2, 1, 1434, 10 } },
  [13] = { szName = "Chưởng Cái Bang", tbGDPL = { 2, 1, 1435, 10 } },
  [14] = { szName = "Côn Cái Bang", tbGDPL = { 2, 1, 1436, 10 } },
  [15] = { szName = "Ma Thiên Nhẫn", tbGDPL = { 2, 1, 1438, 10 } },
  [16] = { szName = "Chiến Thiên Nhẫn", tbGDPL = { 2, 1, 1437, 10 } },
  [17] = { szName = "Kiếm Võ Đang", tbGDPL = { 2, 1, 1440, 10 } },
  [18] = { szName = "Khí Võ Đang", tbGDPL = { 2, 1, 1439, 10 } },
  [19] = { szName = "Đao Côn Lôn", tbGDPL = { 2, 1, 1441, 10 } },
  [20] = { szName = "Kiếm Côn Lôn", tbGDPL = { 2, 1, 1442, 10 } },
  [21] = { szName = "Kiếm Minh Giáo", tbGDPL = { 2, 1, 1444, 10 } },
  [22] = { szName = "Chùy Minh Giáo", tbGDPL = { 2, 1, 1443, 10 } },
  [23] = { szName = "Khí Đoàn Thị", tbGDPL = { 2, 1, 1446, 10 } },
  [24] = { szName = "Chỉ Đoàn Thị", tbGDPL = { 2, 1, 1445, 10 } },
  [25] = { szName = "Kiếm Cổ Mộ", tbGDPL = { 2, 1, 1529, 10 } },
  [26] = { szName = "Châm Cổ Mộ", tbGDPL = { 2, 2, 245, 10 } },
}

tbMenPaiNpc.GUMU_MAX_JOIN_LEVEL = 20

tbMenPaiNpc.tbMiJiBox = {
  [1] = { 18, 1, 1844, 1 },
  [2] = { 18, 1, 1845, 1 },
}

tbMenPaiNpc.nTaskGroup_Miji = 2093
tbMenPaiNpc.nTaskId_ZhongMiji = 79
tbMenPaiNpc.nTaskId_GaoMiji = 80

tbMenPaiNpc.nZhongJiTaskId = 339
tbMenPaiNpc.nGaoJiTaskId = 468

function tbMenPaiNpc:FactionDialog(fnCall)
  local tbOpt = {}
  for nFactionId, tbFaction in ipairs(Player.tbFactions) do
    tbOpt[#tbOpt + 1] = { tbFaction.szName, fnCall, self, nFactionId }
  end
  tbOpt[#tbOpt + 1] = "Kết thúc đối thoại"
  Dialog:Say("Chọn môn phái ngươi muốn đối thoại?", tbOpt)
end

function tbMenPaiNpc:DialogMaster(nFaction)
  if not nFaction then
    return 0
  end
  if me.nFaction and me.nFaction ~= 0 then
    local szFactionName = Player:GetFactionRouteName(me.nFaction)
    if nFaction == me.nFaction then
      local tbOpt = {
        { "Ta muốn tu luyện", self.OfferXiuLian, self },
        { "Ta muốn mua trang bị Thi Đấu Môn Phái", FactionBattle.tbFactionShop.OpenShop, FactionBattle.tbFactionShop, nFaction },
        { "Hoạt động Thi Đấu Môn Phái", FactionBattle.ChoiceFunc, FactionBattle, nFaction },
        { "Trao cho Đại Sư Huynh (Đại Sư Tỷ)", FactionElect.ObtainWinnerTitle, FactionElect },
        --{"Ta muốn vào Tẩy Tủy Đảo để song tu môn phái khác", Xisuidao.OnEnterXisuidao_Duoxiu, Xisuidao, me},

        { "Kết thúc đối thoại" },
      }

      Faction:InitChangeFaction(me)
      local nChangeGerneIndex = Faction:GetChangeGenreIndex(me)
      if nChangeGerneIndex == 0 then
        table.insert(tbOpt, #tbOpt - 1, { "Ta muốn vào Tẩy Tủy Đảo để tẩy điểm", Xisuidao.OnEnterXisuidao_Xidian, Xisuidao, me })
        table.insert(tbOpt, #tbOpt - 1, { "Ta muốn vào Tẩy Tủy Đảo để song tu môn phái khác", Xisuidao.OnEnterXisuidao_Duoxiu, Xisuidao, me })
        table.insert(tbOpt, #tbOpt - 1, { "Ta muốn vào Tẩy Tủy Đảo để đổi môn phái song tu", Xisuidao.OnEnterXisuidao_ModifyDuoxiu, Xisuidao, me })
      else
        table.insert(tbOpt, #tbOpt - 1, { "Ta muốn trở về Tẩy Tủy Đảo", Xisuidao.OnRecoverXisuidao, Xisuidao, me })
      end

      local szMsg = string.format("Chưởng môn: Ngươi đã là đệ tử của %s. Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.", szFactionName)

      if 20 <= me.nLevel then
        local tbMijiDialog = { "Nhận Mật Tịch bản môn", self.OnAskMiji, self }
        table.insert(tbOpt, 1, tbMijiDialog)
      end
      if 60 <= me.nLevel then
        local tbSignetDialog = { "Nhận Ngũ Hành Ấn", self.OnAskSignet, self, nFaction }
        table.insert(tbOpt, 1, tbSignetDialog)
      end

      if nFaction == Env.FACTION_ID_GUMU then
        local nMainFaction = Faction:GetOriginalFaction(me)
        if nMainFaction <= 0 or nMainFaction == Env.FACTION_ID_GUMU then
          table.insert(tbOpt, #tbOpt - 1, { "Nhận thú cưỡi phái Cổ Mộ", self.GetGuMuHorse, self })
        end
      end

      local nIsCanGetFreeZhongJiMiji = self:IsCanGetFreeZhongJiMiJi(me)
      if 1 == nIsCanGetFreeZhongJiMiji then
        table.insert(tbOpt, #tbOpt - 1, { "Nhận Rương Mật Tịch Trung Cấp", self.GetFreeZhongJiMiJi, self })
      end

      local nIsCanGetFreeGaoJiMiji = self:IsCanGetFreeGaoJiMiJi(me)
      if 1 == nIsCanGetFreeGaoJiMiji then
        table.insert(tbOpt, #tbOpt - 1, { "Nhận Rương Mật Tịch Cao Cấp", self.GetFreeGaoJiMiJi, self })
      end

      Dialog:Say(szMsg, tbOpt)
      return
    else
      Dialog:Say("Chưởng môn: Ngươi đã là đệ tử " .. szFactionName .. ", không thể gia nhập bản phái.")
      return
    end
    return
  end

  self:JoinZhuXiuFaction(nFaction)
end

function tbMenPaiNpc:IsCanGetFreeZhongJiMiJi(pPlayer)
  if pPlayer.nLevel < 70 then
    return 0, "Cấp độ của ngài chưa đạt 70, không thể nhận Rương Mật Tịch Trung Cấp."
  end

  local nIsGet = pPlayer.GetTask(self.nTaskGroup_Miji, self.nTaskId_ZhongMiji)
  if nIsGet > 0 then
    return 0, "Ngài đã nhận Mật Tịch Trung Cấp rồi!"
  end

  -- Nhiệm vụ đang tồn tại
  if Task:GetPlayerTask(pPlayer).tbTasks[self.nZhongJiTaskId] then
    return 0, "Ngài đã nhận nhiệm vụ [Bách Xích Kinh], sau khi hoàn thành sẽ nhận được Mật Tịch Trung Cấp!"
  end

  if Task:GetFinishedIdx(self.nZhongJiTaskId) > 0 then
    return 0, "Ngài đã nhận Mật Tịch Trung Cấp thông qua nhiệm vụ [Bách Xích Kinh] rồi!"
  end

  return 1
end

function tbMenPaiNpc:GetFreeZhongJiMiJi()
  local nFlag, szError = self:IsCanGetFreeZhongJiMiJi(me)
  if 1 ~= nFlag then
    Dialog:Say(szError)
    return 0
  end

  if 1 > me.CountFreeBagCell() then
    Dialog:Say("Hành trang của ngươi không đủ 1 ô trống, hãy mau dọn dẹp hành trang!")
    return 0
  end

  me.SetTask(self.nTaskGroup_Miji, self.nTaskId_ZhongMiji, GetTime())
  local pItem = me.AddItem(unpack(self.tbMiJiBox[1]))
  if pItem then
    pItem.Bind(1)
  end
  return 1
end

function tbMenPaiNpc:IsCanGetFreeGaoJiMiJi(pPlayer)
  if pPlayer.nLevel < 100 then
    return 0, "Cấp độ của ngài chưa đạt 100, không thể nhận Rương Mật Tịch Cao Cấp."
  end

  local nIsGet = pPlayer.GetTask(self.nTaskGroup_Miji, self.nTaskId_GaoMiji)
  if nIsGet > 0 then
    return 0, "Ngài đã nhận Rương Mật Tịch Cao Cấp rồi!"
  end

  if Task:GetPlayerTask(pPlayer).tbTasks[self.nGaoJiTaskId] then
    return 0, "Ngài đã nhận nhiệm vụ [Vô Tự Thiên Thư], sau khi hoàn thành sẽ nhận được Mật Tịch Cao Cấp!"
  end

  if Task:GetFinishedIdx(self.nGaoJiTaskId) > 0 then
    return 0, "Ngài đã nhận Mật Tịch Cao Cấp thông qua nhiệm vụ [Vô Tự Thiên Thư] rồi!"
  end

  return 1
end

function tbMenPaiNpc:GetFreeGaoJiMiJi()
  local nFlag, szError = self:IsCanGetFreeGaoJiMiJi(me)
  if 1 ~= nFlag then
    Dialog:Say(szError)
    return 0
  end
  if 1 > me.CountFreeBagCell() then
    Dialog:Say("Hành trang của ngươi không đủ 1 ô trống, hãy mau dọn dẹp hành trang!")
    return 0
  end
  me.SetTask(self.nTaskGroup_Miji, self.nTaskId_GaoMiji, GetTime())
  local pItem = me.AddItem(unpack(self.tbMiJiBox[2]))
  if pItem then
    pItem.Bind(1)
  end
  return 1
end

tbMenPaiNpc.tbGuMuHorse = {
  [Env.SEX_MALE] = {
    { "Túy Nguyệt · Vô Tà (Thú cưỡi Kiếm Cổ Mộ)", { 1, 12, 65, 1 } },
    { "Túy Nguyệt · Thanh Huy (Thú cưỡi Kiếm Cổ Mộ)", { 1, 12, 65, 2 } },
    { "Túy Nguyệt · Trục Quân (Thú cưỡi Kiếm Cổ Mộ)", { 1, 12, 65, 3 } },
    { "Xích Luyện · Mạc Trần (Thú cưỡi Châm Cổ Mộ)", { 1, 12, 66, 1 } },
    { "Xích Luyện · Ái Nhiễm (Thú cưỡi Châm Cổ Mộ)", { 1, 12, 66, 2 } },
    { "Xích Luyện · Ma Hoa (Thú cưỡi Châm Cổ Mộ)", { 1, 12, 66, 3 } },
  },
  [Env.SEX_FEMALE] = {
    { "Túy Nguyệt · Vô Tà (Thú cưỡi Kiếm Cổ Mộ)", { 1, 12, 65, 1 } },
    { "Túy Nguyệt · Thanh Huy (Thú cưỡi Kiếm Cổ Mộ)", { 1, 12, 65, 2 } },
    { "Túy Nguyệt · Trục Quân (Thú cưỡi Kiếm Cổ Mộ)", { 1, 12, 65, 3 } },
    { "Ly Ảnh · Toái Thần (Thú cưỡi Châm Cổ Mộ)", { 1, 12, 67, 1 } },
    { "Ly Ảnh · Tiêu Nhiễm (Thú cưỡi Châm Cổ Mộ)", { 1, 12, 67, 2 } },
    { "Ly Ảnh · Huyền Vũ (Thú cưỡi Châm Cổ Mộ)", { 1, 12, 67, 3 } },
  },
}

function tbMenPaiNpc:GetGuMuHorse(nIndex, nFlag)
  local nPlayerLevel = me.nLevel
  local nFaction = me.nFaction

  if nFaction ~= Env.FACTION_ID_GUMU then
    Dialog:Say("Môn phái hiện tại của ngươi không phải Cổ Mộ Phái, hãy chuyển sang Cổ Mộ Phái!")
    return 0
  end

  if nPlayerLevel <= 0 then
    Dialog:Say("Ngươi chưa đạt cấp 20, không thể nhận!")
    return 0
  end

  if 1 > me.CountFreeBagCell() then
    Dialog:Say("Hành trang của ngươi không đủ 1 ô trống, hãy mau dọn dẹp hành trang!")
    return 0
  end

  if not nFlag then
    local szMsg = "Ngươi có thể chọn nhận một trong các thú cưỡi của Cổ Mộ Phái sau đây:"
    local tbOpt = {}
    local tbSexList = self.tbGuMuHorse[me.nSex]
    for i, tbInfo in pairs(tbSexList) do
      tbOpt[#tbOpt + 1] = { string.format("<color=yellow>%s<color>", tbInfo[1]), self.GetGuMuHorse, self, i, 1 }
    end
    Dialog:Say(szMsg, tbOpt)
    return 0
  end

  if not nIndex then
    Dialog:Say("Lựa chọn thú cưỡi bất thường!")
    return 0
  end

  local tbHorse = self.tbGuMuHorse[me.nSex][nIndex]

  local pItem = me.AddItem(unpack(tbHorse[2]))
  if pItem then
    pItem.Bind(1)
    pItem.Sync()
  end

  return 1
end

function tbMenPaiNpc:JoinZhuXiuFaction(nFaction)
  if nFaction == Env.FACTION_ID_GUMU then
    local nIsOpenZhuxiu = Faction:IsOpenGumuZhuxiu()
    if nIsOpenZhuxiu ~= 1 then
      Dialog:Say("Chưởng môn: Vị thiếu hiệp này, xem cốt cách của ngươi thật kỳ lạ, tư chất hơn người, tiếc là còn thiếu minh sư chỉ điểm. Nếu có thể gia nhập bản phái, được ta chân truyền, tương lai ắt thành đại khí!\n" .. "<color=yellow>Hiện tại máy chủ này chưa mở phái Cổ Mộ.<color>\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>", {
        { "Đã hiểu" },
      })
      return
    end

    if me.nLevel > self.GUMU_MAX_JOIN_LEVEL then
      Dialog:Say(string.format("Chưởng môn: Vị thiếu hiệp này, xem cốt cách của ngươi thật kỳ lạ, tư chất hơn người, chỉ là người gia nhập môn phái ta cần phải không có môn phái và cấp độ dưới %s, ngươi đã vượt quá cấp %s, thật đáng tiếc không thể gia nhập môn phái!\n", self.GUMU_MAX_JOIN_LEVEL, self.GUMU_MAX_JOIN_LEVEL) .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>", {
        { "Đã hiểu" },
      })

      return
    end
  end

  Dialog:Say("Chưởng môn: Vị thiếu hiệp này, xem cốt cách của ngươi thật kỳ lạ, tư chất hơn người, tiếc là còn thiếu minh sư chỉ điểm. Nếu có thể gia nhập bản phái, được ta chân truyền, tương lai ắt thành đại khí!\n" .. "<color=green>Nếu muốn từ bản đồ môn phái trở về các Tân Thủ Thôn, có thể đối thoại với Người Dịch Chuyển Môn Phái để quay lại.<color>", {
    { "Sư phụ tại thượng, xin nhận của đệ tử một lạy", self.Join2, self, nFaction },
    { "Để ta suy nghĩ thêm" },
  })
end

function tbMenPaiNpc:OfferXiuLian()
  local nLevel = me.nLevel
  if nLevel < 20 then
    Dialog:Say("Chưởng môn: Tu luyện ư? Ngươi vẫn chưa đủ trình độ, hãy đi luyện công cơ bản cho tốt rồi hãy đến.<color=red>(Cần đạt cấp 20)<color>")
  else
    local nCount = me.GetItemCountInBags(18, 1, 16, 1)
    if nCount == 0 then
      local szMsg = "Chưởng môn: Không ngờ ngươi đã nhập môn lâu như vậy rồi, " .. "đã đến lúc dạy ngươi cách kích phát tiềm năng bản thân để đạt đến tu vi cao hơn. Đây là một viên Tu Luyện Châu, " .. "nó có thể giúp ngươi kích phát tiềm năng, " .. "<color=green>giúp ngươi nhận kinh nghiệm chiến đấu với tốc độ gấp 4 lần bình thường, đồng thời cũng sẽ khiến ngươi trở nên đặc biệt may mắn.<color>" .. "Tiềm năng của bản thân cũng cần phải tích lũy. Với trạng thái của ngươi, mỗi ngày có thể tích lũy khoảng <color=red>1.5<color> giờ, mỗi ngày hãy làm theo sức mình. " .. "À, đúng rồi, viên Tu Luyện Châu này bản thân nó không đáng tiền, <color=green>nếu mất có thể quay lại tìm ta nhận bất cứ lúc nào.<color>"
      local tbOpt = { { "Ta muốn nhận Tu Luyện Châu", self.GetXiuLianZhu, self }, { "Kết thúc đối thoại" } }
      Dialog:Say(szMsg, tbOpt)
    else
      Dialog:Say("<color=red>Ngươi đã có Tu Luyện Châu rồi!<color>")
    end
  end
end

function tbMenPaiNpc:GetXiuLianZhu()
  local tbXiulianzhuItem = { Item.SCRIPTITEM, 1, 16, 1 }
  local tbBaseProp = KItem.GetItemBaseProp(unpack(tbXiulianzhuItem))
  if not tbBaseProp then
    return
  end

  local tbItem = {
    nGenre = tbXiulianzhuItem[1],
    nDetail = tbXiulianzhuItem[2],
    nParticular = tbXiulianzhuItem[3],
    nLevel = tbXiulianzhuItem[4],
    nSeries = (tbBaseProp.nSeries > 0) and tbBaseProp.nSeries or 0,
    bBind = KItem.IsItemBindByBindType(tbBaseProp.nBindType),
    nCount = 1,
  }

  if 0 == me.CanAddItemIntoBag(tbItem) then
    me.Msg("Hành trang đã đầy")
    return
  end

  tbXiulianzhuItem[5] = tbItem.nSeries
  me.AddItem(unpack(tbXiulianzhuItem))
  me.Msg("Bạn nhận được một viên Tu Luyện Châu!")
end

function tbMenPaiNpc:OnAskMiji()
  local szMsg = "Ngươi muốn chọn Mật Tịch của nhánh môn phái nào?"
  local tbOpt = {}
  for i = 1, 2 do
    local szRouteName = Player:GetFactionRouteName(me.nFaction, i)
    local tbMiji = { szRouteName, self.OnAskForMoney, self, me.nFaction, i }
    table.insert(tbOpt, tbMiji)
  end
  Dialog:Say(szMsg, tbOpt)
end

function tbMenPaiNpc:OnAskSignet(nFaction, bConfirm)
  if me.CountFreeBagCell() < 1 then
    Dialog:Say("Hành trang của ngươi không đủ chỗ")
    return 0
  end
  if not bConfirm then
    Dialog:Say("Ngươi có chắc muốn nhận Ngũ Hành Ấn không?", {
      { "Đúng vậy, ta muốn nhận", self.OnAskSignet, self, nFaction, 1 },
      { "Ta đã có Ngũ Hành Ấn rồi" },
    })
    return 0
  end

  me.AddItem(1, 16, nFaction, 1, 0)
end

function tbMenPaiNpc:OnAskForMoney(nFaction, nRouteId)
  local szMsg = "Tất cả đệ tử trong phái khi đạt <color=red>cấp 20<color>, đều sẽ nhận được thư bồ câu do chính ta gửi, miễn phí nhận một cuốn Mật Tịch của nhánh tu luyện.<color=green>(Gợi ý: Nhấn phím “I” để mở giao diện thư bồ câu)<color>\n" .. "Nhận lại Mật Tịch cần <color=yellow>500<color> Bạc, ngươi có chắc chắn muốn nhận không?"
  local tbOpt = {
    { "Ta chắc chắn nhận.", self.OnOfferMiji, self, nFaction, nRouteId },
    { "Để ta suy nghĩ lại." },
  }
  Dialog:Say(szMsg, tbOpt)
end

function tbMenPaiNpc:OnOfferMiji(nFaction, nRouteId)
  local nMyMoney = me.nCashMoney --GetCash();

  if nMyMoney < 500 then
    Dialog:Say("Ngươi không đủ Bạc, hãy mang đủ rồi quay lại.")
    return 0
  end

  if 0 == nFaction then
    print("Chưa gia nhập môn phái? Sao có thể?")
    return 0
  end

  if 0 == nRouteId then
    Dialog:Say("Chưa chọn nhánh, không thể nhận Mật Tịch bản môn!")
    return 0
  end
  self:GetMiji(nFaction, nRouteId)
end

function tbMenPaiNpc:GetMiji(nFaction, nRouteId)
  local nMijiId = self.tbFcts[nFaction].tbMiji[nRouteId]
  local nCount = me.GetItemCountInBags(1, 14, nMijiId, 1, -1)
  if 0 < nCount then
    Dialog:Say("Ngươi đã có Mật Tịch rồi!")
    return 0
  end
  local tbMijiItem = { Item.EQUIP_GENERAL, 14, nMijiId, 1 }
  local tbBaseProp = KItem.GetItemBaseProp(unpack(tbMijiItem))
  if not tbBaseProp then
    return 0
  end

  local tbItem = {
    nGenre = tbMijiItem[1],
    nDetail = tbMijiItem[2],
    nParticular = tbMijiItem[3],
    nLevel = tbMijiItem[4],
    nSeries = (tbBaseProp.nSeries > 0) and tbBaseProp.nSeries or 0,
    bBind = KItem.IsItemBindByBindType(tbBaseProp.nBindType),
    nCount = 1,
  }

  if 0 == me.CanAddItemIntoBag(tbItem) then
    me.Msg("Hành trang đã đầy")
    return
  end

  if 0 >= me.CostMoney(500, Player.emKPAY_MIJI) then
    print("[MiJi] tbMenPaiNpc:GetMiji(nFaction, nRouteId) the money is wrong!")
    return 0
  end

  tbMijiItem[5] = tbItem.nSeries
  me.AddItem(unpack(tbMijiItem))
  Dialog:Say("Mật Tịch đã giao cho ngươi, đây là bí kíp của bản môn, tuyệt đối không được truyền ra ngoài.")
  return 1
end

function tbMenPaiNpc:Join2(nFaction)
  --	if (me.GetCamp() == 5) then
  --		Dialog:Say("Chưởng môn: Thân là GM, không thể gia nhập bất kỳ môn phái nào.");
  --		return 0;
  --	end
  local nSex = me.nSex
  local nSexLimit = Player.tbFactions[nFaction].nSexLimit
  if nSexLimit and nSexLimit >= 0 and nSexLimit ~= nSex then
    Dialog:Say("Chưởng môn: Bản phái không thu nhận đệ tử " .. Player.SEX[nSex] .. ", mời thí chủ tìm phái khác.")
    return 0
  end
  if me.nLevel < 10 then
    Dialog:Say("Chưởng môn: Cấp độ của ngươi chưa đủ, không thể gia nhập môn phái, hãy tu luyện đến <color=red>cấp 10<color> rồi quay lại!")
    return 0
  end
  local nCurFaction = me.nFaction
  local szFactionName
  if nCurFaction ~= 0 then
    szFactionName = Player:GetFactionRouteName(nCurFaction)
    Dialog:Say("Chưởng môn: Ngươi đã là đệ tử của " .. szFactionName .. ", không thể gia nhập bản phái")
    return 0
  end
  --Rời đội trước, để tránh màu tên trắng không đổi
  me.LeaveTeam()
  me.JoinFaction(nFaction)
  self:AddAngerMagic(me)
  szFactionName = Player:GetFactionRouteName(nFaction)

  -- Tự động cộng điểm
  Player:ReAssignPotential()

  -- Tài khoản GM
  if me.GetCamp() == 6 then
    me.AddFightSkill(91, 60) -- Ngân Tơ Phi Chu
    me.AddFightSkill(163, 60) -- Thê Vân Tung
    me.AddFightSkill(1417, 1) -- Di Hình Hoán Ảnh cấp 1
  end

  local nInEducation = me.GetTask(1021, 7)
  local szMsg = ""
  if nInEducation == 1 then
    szMsg = "Ngươi đã vào môn hạ của ta, cần phải chăm chỉ khổ luyện. Tuyệt học của bản phái tuy bác đại tinh thâm, nhưng vẫn không thể thiếu bốn chữ cần cù khổ luyện. Ngươi có thể về thôn báo lại cho Thu Lâm, ngày thường tự mình tu luyện thêm, đặt nền móng vững chắc, sau này trên giang hồ mới có thể trừ gian diệt ác, không để yêu tà hoành hành. Nếu ta đoán không lầm, duyên sư đồ của chúng ta còn dài, không lâu nữa sẽ gặp lại, hãy xuống núi trước đi."
  else
    szMsg = "Đã vào môn hạ của ta, phải chăm chỉ nỗ lực, sau này mới có thể thành tựu, không phụ công dạy dỗ của bản môn."
  end
  --Thành tựu
  Achievement:FinishAchievement(me, 414)
  Dialog:Say(szMsg .. "\n\n" .. "Nhấn nút trên bảng kỹ năng, hoặc dùng phím tắt F3 để mở bảng kỹ năng, có thể thấy hai nhánh lựa chọn của bản môn.\n\n" .. "<color=yellow>Võ công bản môn có hai nhánh, võ công của các nhánh khác nhau yêu cầu sử dụng loại vũ khí tương ứng. Một khi đã chọn kỹ năng của một nhánh nào đó, cộng vào một điểm, trước cấp 60 chỉ có thể tu luyện nhánh này, phải lựa chọn cẩn thận. Sau cấp 60 có thể đến chỗ ta để dịch chuyển vào Tẩy Tủy Đảo để đổi nhánh.\n\n" .. "Khi ngươi đạt cấp 20, có thể quay lại tìm ta nhận Tu Luyện Châu, nó sẽ giúp tăng hiệu suất luyện công của ngươi rất nhiều.<color>", { { "Đệ tử tuân lệnh" } })
  me.Msg("Bạn đã gia nhập thành công " .. szFactionName .. ", và học được kỹ năng " .. szFactionName .. ", vui lòng mở bảng kỹ năng (F3) để cộng điểm.")
  me.Msg("Bạn đã nhận được kỹ năng Nộ khí mới!")
end

function tbMenPaiNpc:AddAngerMagic(pPlayer)
  local tbAngerSkill = FightSkill.tbAngerSkill
  local nSeries = pPlayer.nSeries
  if pPlayer.IsHaveSkill(281) == 1 then
    pPlayer.DelFightSkill(281)
  end
  pPlayer.AddFightSkill(tbAngerSkill[nSeries], 1)
end

-- Kiểm tra xem người chơi có đủ điều kiện để trải nghiệm kỹ năng môn phái không
function tbMenPaiNpc:CanTrySkill()
  -- Chỉ những người chơi có giá trị biến này là 1 mới có thể trải nghiệm kỹ năng
  if me.GetTask(1022, 225) ~= 1 then
    return 0
  end

  return 1
end

function tbMenPaiNpc:DialogJieYinRen(nFaction)
  local szMsg = "<color=yellow>" .. him.szName .. "<color>: " .. self.tbFcts[nFaction].szDesc
  local tbOpt = {}

  if me.nLevel >= 20 and GetMapType(me.nMapId) ~= "village_mini" then
    table.insert(tbOpt, { "Dịch chuyển đến " .. Player:GetFactionRouteName(nFaction), self.Transfer, self, nFaction })
  end

  table.insert(tbOpt, { "Giới thiệu kỹ năng môn phái " .. Player:GetFactionRouteName(nFaction), self.OpenMenPaiDes, self, nFaction })

  -- Mỗi môn phái tương ứng với hai nhánh
  local nIndex1 = 2 * nFaction - 1
  local nIndex2 = 2 * nFaction

  if self:CanTrySkill() == 1 and self.tbFactionWeaponInfo[nIndex1] and self.tbFactionWeaponInfo[nIndex2] then
    local szMsg1 = string.format("Trải nghiệm kỹ năng <color=yellow>%s<color>", self.tbFactionWeaponInfo[nIndex1].szName)
    table.insert(tbOpt, { szMsg1, self.GetItem4TrySkillDlg, self, nIndex1, nFaction, self.tbFactionWeaponInfo[nIndex1].szName })

    local szMsg2 = string.format("Trải nghiệm kỹ năng <color=yellow>%s<color>", self.tbFactionWeaponInfo[nIndex2].szName)
    table.insert(tbOpt, { szMsg2, self.GetItem4TrySkillDlg, self, nIndex2, nFaction, self.tbFactionWeaponInfo[nIndex2].szName })

    table.insert(tbOpt, { "Ta không muốn trải nghiệm kỹ năng môn phái", self.LeaveWithoutTrySkill, self, nFaction })
  else
    table.insert(tbOpt, { "Rời đi" })
  end

  Dialog:Say(szMsg, tbOpt)
end

function tbMenPaiNpc:OpenMenPaiDes(nFaction)
  me.CallClientScript({ "UiManager:OpenWindow", "UI_SCHOOLDEMO", nFaction })
end

function tbMenPaiNpc:LeaveWithoutTrySkill(nFaction)
  me.SetTask(Player.TSKGROUP_NEWPLAYER_GUIDE, Player.TSKID_NEWPLAYER_FACTION, nFaction)
end

function tbMenPaiNpc:GetItem4TrySkillDlg(nIndex, nFaction, szSkillName)
  local szMsg = string.format("Ngươi có chắc muốn trải nghiệm kỹ năng của <color=yellow>%s<color> không? (Lưu ý:\n<color=yellow>1. Vũ khí dùng để trải nghiệm kỹ năng môn phái có hiệu lực 10 phút.<color>\n2. Nếu ngươi đã trải nghiệm kỹ năng khác, khi trải nghiệm kỹ năng này, kỹ năng trải nghiệm lần trước sẽ mất hiệu lực.)", szSkillName)
  local tbOpt = {
    { "Đúng vậy, ta muốn trải nghiệm", self.GetItem4TrySkill, self, nIndex, nFaction },
    { "Để ta suy nghĩ lại" },
  }
  Dialog:Say(szMsg, tbOpt)
end

-- Nhận vật phẩm chỉ định để thử kỹ năng môn phái
function tbMenPaiNpc:GetItem4TrySkill(nIndex, nFaction)
  if not nIndex or not self.tbFactionWeaponInfo[nIndex] then
    return
  end

  me.SetTask(Player.TSKGROUP_NEWPLAYER_GUIDE, Player.TSKID_NEWPLAYER_FACTION, nFaction)

  -- Xóa vũ khí thử kỹ năng môn phái hiện có trên người (nếu có)
  self:DelTrySkillWeapon()

  if me.CountFreeBagCell() < 1 then
    me.Msg("Hành trang của ngươi không còn chỗ trống, hãy dọn dẹp 1 ô rồi quay lại.")
    return
  end

  local tbGDPL = self.tbFactionWeaponInfo[nIndex].tbGDPL
  Lib:ShowTB(tbGDPL)
  local pItem = me.AddItem(unpack(tbGDPL))
  if pItem then
    me.SetItemTimeout(pItem, os.date("%Y/%m/%d/%H/%M/%S", GetTime() + self.WEAPON_LIVE_TIME))
    if me.CanUseItem(pItem) == 1 then
      me.AutoEquip(pItem) -- Tự động trang bị
      self:TrySkillDlg()
    end
  end
end

-- Hỏi người chơi có muốn dịch chuyển đến bản đồ cấp 5 để trải nghiệm kỹ năng môn phái không
function tbMenPaiNpc:TrySkillDlg()
  local szMsg = string.format("Ngươi có muốn dịch chuyển đến bản đồ cấp 5 gần nhất để trải nghiệm kỹ năng môn phái không?\nLưu ý: Hiện tại các kỹ năng có thể trải nghiệm trước đã xuất hiện trong bảng kỹ năng F3, ngươi có thể kéo các kỹ năng này vào thanh phím tắt để trải nghiệm.")
  local tbOpt = {
    { "Được, hãy đưa ta đến đó", self.Send2Lv5Map, self },
    { "Để sau hãy nói" },
  }
  Dialog:Say(szMsg, tbOpt)
end

-- Đưa người chơi đến bản đồ cấp 5 gần nhất
function tbMenPaiNpc:Send2Lv5Map()
  local nMapId = me.nMapId
  local tbPos = self.TBLV5_TRYSKILL_POS[nMapId]
  if tbPos then
    me.NewWorld(unpack(tbPos))
  end
end

-- Xóa vật phẩm dùng để trải nghiệm kỹ năng môn phái đã có trên người
function tbMenPaiNpc:DelTrySkillWeapon()
  local tbAllRoom = {
    Item.ROOM_EQUIP,
    Item.ROOM_EQUIPEX,
    Item.ROOM_MAINBAG,
    Item.ROOM_EXTBAG1,
    Item.ROOM_EXTBAG2,
    Item.ROOM_EXTBAG3,
    Item.ROOM_REPOSITORY,
    Item.ROOM_EXTBAGBAR,
    Item.ROOM_MAIL,
    Item.ROOM_TRADE,
    Item.ROOM_TRADECLIENT,
    Item.ROOM_RECYCLE,
  }

  local tbCurGDPL = {}
  for _, tbInfo in pairs(self.tbFactionWeaponInfo) do
    local szGDPL = string.format("%s-%s-%s-%s", unpack(tbInfo.tbGDPL))
    tbCurGDPL[szGDPL] = {}
  end

  -- Trước khi nhận vũ khí thử nghiệm mới, cần xóa vũ khí thử nghiệm cũ (nếu có)
  for _, nRoom in pairs(tbAllRoom) do
    local tbIdx = me.FindAllItem(nRoom)
    if tbIdx then
      for i = 1, #tbIdx do
        local pItem = KItem.GetItemObj(tbIdx[i])
        if pItem then
          local szGDPL = string.format("%s-%s-%s-%s", pItem.nGenre, pItem.nDetail, pItem.nParticular, pItem.nLevel)
          if tbCurGDPL[szGDPL] then
            pItem.Delete(me)
          end
        end
      end
    end
  end
end

function tbMenPaiNpc:Transfer(nFaction)
  if me.nLevel < 10 then
    Dialog:Say("Công lực của ngươi còn yếu, cần tu luyện đến <color=yellow>cấp 10<color> mới có thể dịch chuyển.")
    return 0
  end
  me.NewWorld(unpack(self.tbFcts[nFaction].tbTransPos))
end

function tbMenPaiNpc:Intro(nFaction)
  Dialog:Say(self.tbFcts[nFaction].szDesc, {
    { "Trở về trang trước", self.DialogJieYinRen, self, nFaction },
    { "Rời đi" },
  })
end

function tbMenPaiNpc:LearnSkill()
  if me.nLevel < 10 then
    Dialog:Say("Ngươi đã học được kỹ năng rồi.")
    return 0
  end
end

-- ?pl DoScript("\\script\\npc\\faction\\menpainpc.lua")
